(function(a){var b=(typeof exports==='object'),c=(typeof JS==='undefined')?require('./core'):JS,d=c.Console||require('./console').Console,g=c.DOM||require('./dom').DOM,j=c.Enumerable||require('./enumerable').Enumerable,k=c.SortedSet||require('./set').SortedSet,m=c.Range||require('./range').Range,l=c.Hash||require('./hash').Hash,o=c.MethodChain||require('./method_chain').MethodChain,n=c.Comparable||require('./comparable').Comparable,q=c.StackTrace||require('./stack_trace').StackTrace;if(b)exports.JS=exports;a(c,d,g,j,k,m,l,o,n,q,b?exports:c)})(function(h,p,u,t,z,A,B,C,F,y,D){'use strict';var f=new h.Module('Test',{extend:{asyncTimeout:5,filter:function(a,b){return f.Runner.filter(a,b)},Reporters:new h.Module({extend:{METHODS:['startSuite','startContext','startTest','update','addFault','endTest','endContext','endSuite'],_13:{},register:function(a,b){this._13[a]=b},get:function(a){if(!a)return null;return this._13[a]||null}}}),UI:new h.Module({}),Unit:new h.Module({})}});f.Unit.extend({Observable:new h.Module({addListener:function(a,b,c){if(b===undefined)throw new Error('No callback was passed as a listener');this.channels()[a]=this.channels()[a]||[];this.channels()[a].push([b,c]);return b},removeListener:function(a,b,c){var d=this.channels()[a];if(!d)return;var g=d.length;while(g--){if(d[g][0]===b){d.splice(g,1);return b}}return null},notifyListeners:function(a,b){var b=h.array(arguments),a=b.shift(),c=this.channels()[a];if(!c)return 0;for(var d=0,g=c.length;d<g;d++)c[d][0].apply(c[d][1]||null,b);return c.length},channels:function(){return this.__channels__=this.__channels__||[]}})});f.Unit.extend({AssertionFailedError:new h.Class(Error,{initialize:function(a){this.message=a.toString()}}),Assertions:new h.Module({assertBlock:function(a,b,c){if(typeof a==='function'){c=b;b=a;a=null}this.__wrapAssertion__(function(){if(!b.call(c||null)){a=this.buildMessage(a||'assertBlock failed');throw new f.Unit.AssertionFailedError(a);}})},flunk:function(a){this.assertBlock(this.buildMessage(a||'Flunked'),function(){return false})},assert:function(a,b){this.__wrapAssertion__(function(){this.assertBlock(this.buildMessage(b,'<?> is not true',a),function(){return a})})},assertEqual:function(a,b,c){var d=this.buildMessage(c,'<?> expected but was\n<?>',a,b);this.assertBlock(d,function(){return t.areEqual(a,b)})},assertNotEqual:function(a,b,c){var d=this.buildMessage(c,'<?> expected not to be equal to\n<?>',a,b);this.assertBlock(d,function(){return!t.areEqual(a,b)})},assertNull:function(a,b){this.assertEqual(null,a,b)},assertNotNull:function(a,b){var c=this.buildMessage(b,'<?> expected not to be null',a);this.assertBlock(c,function(){return a!==null})},assertKindOf:function(c,d,g){this.__wrapAssertion__(function(){var a=(!d||typeof c==='string')?typeof d:(d.klass||d.constructor);var b=this.buildMessage(g,'<?> expected to be an instance of\n<?> but was\n<?>',d,c,a);this.assertBlock(b,function(){return h.isType(d,c)})})},assertRespondTo:function(c,d,g){this.__wrapAssertion__(function(){var a=this.buildMessage('','<?>\ngiven as the method name argument to #assertRespondTo must be a String',d);this.assertBlock(a,function(){return typeof d==='string'});var b=c?c.constructor:typeof c;a=this.buildMessage(g,'<?>\nof type <?>\nexpected to respond to <?>',c,b,d);this.assertBlock(a,function(){return c&&c[d]!==undefined})})},assertMatch:function(b,c,d){this.__wrapAssertion__(function(){var a=this.buildMessage(d,'<?> expected to match\n<?>',c,b);this.assertBlock(a,function(){return h.match(b,c)})})},assertNoMatch:function(b,c,d){this.__wrapAssertion__(function(){var a=this.buildMessage(d,'<?> expected not to match\n<?>',c,b);this.assertBlock(a,function(){return(typeof b.test==='function')?!b.test(c):!b.match(c)})})},assertSame:function(a,b,c){var d=this.buildMessage(c,'<?> expected to be the same as\n<?>',a,b);this.assertBlock(d,function(){return b===a})},assertNotSame:function(a,b,c){var d=this.buildMessage(c,'<?> expected not to be the same as\n<?>',a,b);this.assertBlock(d,function(){return b!==a})},assertInDelta:function(b,c,d,g){this.__wrapAssertion__(function(){this.assertKindOf('number',b);this.assertKindOf('number',c);this.assertKindOf('number',d);this.assert(d>=0,'The delta should not be negative');var a=this.buildMessage(g,'<?> and\n<?> expected to be within\n<?> of each other',b,c,d);this.assertBlock(a,function(){return Math.abs(b-c)<=d})})},assertSend:function(b,c){this.__wrapAssertion__(function(){this.assertKindOf(Array,b,'assertSend requires an array of send information');this.assert(b.length>=2,'assertSend requires at least a receiver and a message name');var a=this.buildMessage(c,'<?> expected to respond to\n<?(?)> with a true value',b[0],f.Unit.AssertionMessage.literal(b[1]),b.slice(2));this.assertBlock(a,function(){return b[0][b[1]].apply(b[0],b.slice(2))})})},__processExceptionArgs__:function(a){var a=h.array(a),b=(typeof a[a.length-1]==='function')?null:a.pop(),c=a.pop(),d=h.isType(a[a.length-1],'string')?a.pop():'',g=new t.Collection(a);return[a,g,d,c,b]},assertThrow:function(){var d=this.__processExceptionArgs__(arguments),g=d[0],j=d[1],k=d[2],m=d[3],l=d[4];this.__wrapAssertion__(function(){var b=this.buildMessage(k,'<?> exception expected but none was thrown',g),c;this.assertBlock(b,function(){try{m.call(l)}catch(e){c=e;return true}return false});b=this.buildMessage(k,'<?> exception expected but was\n?',g,c);this.assertBlock(b,function(){return j.any(function(a){return h.isType(c,a)||(c.name&&c.name===a.name)})})})},assertThrows:function(){return this.assertThrow.apply(this,arguments)},assertNothingThrown:function(){var a=this.__processExceptionArgs__(arguments),b=a[0],c=a[1],d=a[2],g=a[3],j=a[4];this.__wrapAssertion__(function(){try{g.call(j)}catch(e){if((b.length===0&&!h.isType(e,f.Unit.AssertionFailedError))||c.any(function(type){return h.isType(e,type)}))this.assertBlock(this.buildMessage(d,'Exception thrown:\n?',e),function(){return false});else throw e;}})},buildMessage:function(){var a=h.array(arguments),b=a.shift(),c=a.shift();return new f.Unit.AssertionMessage(b,c,a)},__wrapAssertion__:function(a){if(this.__assertionWrapped__===undefined)this.__assertionWrapped__=false;if(!this.__assertionWrapped__){this.__assertionWrapped__=true;try{this.addAssertion();return a.call(this)}finally{this.__assertionWrapped__=false}}else{return a.call(this)}},addAssertion:function(){}})});f.Unit.extend({AssertionMessage:new h.Class({extend:{Literal:new h.Class({initialize:function(a){this._1v=a;this.toString=this.inspect},inspect:function(){return this._1v.toString()}}),literal:function(a){return new this.Literal(a)},Template:new h.Class({extend:{create:function(a){var b=a?a.match(/\(\?\)|(?=[^\\])\?|(?:(?!\(\?\))(?:\\\?|[^\?]))+/g):[];return new this(b)}},initialize:function(b){this._14=new t.Collection(b);this.count=this._14.findAll(function(a){return a==='?'||a==='(?)'}).length},result:function(b){if(b.length!==this.count)throw'The number of parameters does not match the number of substitutions';var c=h.array(b);return this._14.collect(function(a){if(a==='(?)')return c.shift().replace(/^\[/,'(').replace(/\]$/,')');if(a==='?')return c.shift();return a.replace(/\\\?/g,'?')}).join('')}})},initialize:function(a,b,c){this._15=a;this._1w=b;this._1x=new t.Collection(c)},template:function(){return this._1y=this._1y||this.klass.Template.create(this._1w)},toString:function(){var b=[],c,d;if(this._15)b.push(this._15);d=this.template().result(this._1x.collect(function(a){return p.convert(a)},this));if(d!=='')b.push(d);return b.join('\n')}})});f.Unit.extend({Failure:new h.Class({initialize:function(a,b){this._M=a;this._1z=b},metadata:function(){return{test:this.testMetadata(),error:this.errorMetadata()}},testMetadata:function(){return this._M.metadata()},errorMetadata:function(){return{type:'failure',message:this._1z}}})});f.Unit.extend({Error:new h.Class({initialize:function(a,b){this._M=a;this._g=b},metadata:function(){return{test:this.testMetadata(),error:this.errorMetadata()}},testMetadata:function(){return this._M.metadata()},errorMetadata:function(){return{type:'error',message:this._g.name+': '+this._g.message,backtrace:p.filterBacktrace(this._g.stack)}}})});f.Unit.extend({TestResult:new h.Class({include:f.Unit.Observable,extend:{CHANGED:'Test.Unit.TestResult.CHANGED',FAULT:'Test.Unit.TestResult.FAULT'},initialize:function(){this._16=this._17=0;this._e=[];this._o=[]},addRun:function(){this._16+=1;this.notifyListeners(this.klass.CHANGED,this)},addFailure:function(a){this._e.push(a);this.notifyListeners(this.klass.FAULT,a);this.notifyListeners(this.klass.CHANGED,this)},addError:function(a){this._o.push(a);this.notifyListeners(this.klass.FAULT,a);this.notifyListeners(this.klass.CHANGED,this)},addAssertion:function(){this._17+=1;this.notifyListeners(this.klass.CHANGED,this)},passed:function(){return this._e.length===0&&this._o.length===0},runCount:function(){return this._16},assertionCount:function(){return this._17},failureCount:function(){return this._e.length},errorCount:function(){return this._o.length},metadata:function(){return{passed:this.passed(),tests:this.runCount(),assertions:this.assertionCount(),failures:this.failureCount(),errors:this.errorCount()}}})});f.Unit.extend({TestSuite:new h.Class({include:t,extend:{STARTED:'Test.Unit.TestSuite.STARTED',FINISHED:'Test.Unit.TestSuite.FINISHED',forEach:function(b,c,d,g){var j=false,k=false,m=b.length,l=-1,o=new h.Date().getTime(),n=f.FakeClock.REAL.setTimeout;var q=function(){k=true;var a=new h.Date().getTime();if(p.BROWSER&&(a-o)>1000){o=a;j=false;n(r,0)}else if(!j){j=true;while(j)r()}};var r=function(){l+=1;if(l===m){j=false;return d&&d.call(g||null)}k=false;c.call(g||null,b[l],q);if(!k)j=false};q()}},initialize:function(a,b){this._p=a;this._2=b},forEach:function(a,b,c){this.klass.forEach(this._2,a,b,c)},run:function(c,d,g,j){if(this._p.fullName)g.call(j||null,this.klass.STARTED,this);this.forEach(function(a,b){a.run(c,b,g,j)},function(){if(this._p.fullName)g.call(j||null,this.klass.FINISHED,this);d.call(j||null)},this)},size:function(){var a=0,b=this._2.length;while(b--){a+=this._2[b].size()}return a},empty:function(){return this._2.length===0},metadata:function(){return h.extend({size:this.size()},this._p)}})});f.Unit.extend({TestCase:new h.Class({include:f.Unit.Assertions,extend:[t,{STARTED:'Test.Unit.TestCase.STARTED',FINISHED:'Test.Unit.TestCase.FINISHED',reports:[],handlers:[],clear:function(){this.testCases=[]},inherited:function(a){if(!this.testCases)this.testCases=[];this.testCases.push(a)},metadata:function(){var a=this.displayName,b=[],c=this,d=f.Unit.TestCase;while(c!==d){b.unshift(c.displayName);c=c.superclass}b.pop();return{fullName:this===d?'':b.concat(a).join(' '),shortName:a,context:this===d?null:b}},suite:function(b,c,d){var g=this.metadata(),j=f.Unit.TestCase,k=g.fullName,m=new t.Collection(this.instanceMethods(c)),l=[],o=[],n,q,r;var v=m.select(function(a){if(!/^test./.test(a))return false;a=a.replace(/^test:\W*/ig,'');return this.filter(k+' '+a,b)},this).sort();for(q=0,r=v.length;q<r;q++){try{l.push(new this(v[q]))}catch(e){}}if(d&&l.length===0){try{l.push(new this('defaultTest'))}catch(e){}}if(this.testCases){for(q=0,r=this.testCases.length;q<r;q++){n=this.testCases[q].suite(b,c,d);if(n.size()===0)continue;o.push(this.testCases[q].displayName);l.push(n)}}g.children=o;return new f.Unit.TestSuite(g,l)},filter:function(a,b){if(!b||b.length===0)return true;var c=b.length;while(c--){if(a.indexOf(b[c])>=0)return true}return false}}],initialize:function(a){if(typeof this[a]!=='function')throw'invalid_test';this._4=a;this._1=true},run:function(a,b,c,d){c.call(d||null,this.klass.STARTED,this);this._N=a;var g=function(){this.exec('teardown',function(){this.exec(function(){f.Unit.mocking.verify()},function(){a.addRun();c.call(d||null,this.klass.FINISHED,this);b()})})};this.exec('setup',function(){this.exec(this._4,g)},g)},exec:function(b,c,d){if(!b)return c.call(this);if(!d)d=c;var g=(typeof b==='function')?b.length:this.__eigen__().instanceMethod(b).arity,j=(typeof b==='function')?b:this[b],k=null,m=false,l=false,o=this;if(g===0)return this._18(function(){j.call(this);c.call(this)},this._19(d));var n=function(a){o.exec(function(){m=true;this._w();if(k)h.ENV.clearTimeout(k);throw a;},c,d)};this._1a(n);this._18(function(){j.call(this,function(a){l=true;o._w();if(k)h.ENV.clearTimeout(k);if(!m)o.exec(a,c,d)})},this._19(d));if(!l&&h.ENV.setTimeout)k=h.ENV.setTimeout(function(){o.exec(function(){m=true;this._w();throw new Error('Timed out after waiting '+f.asyncTimeout+' seconds for test to resume');},c,d)},f.asyncTimeout*1000)},_1a:function(a,b){if(!a)return;this._w(false);if(p.NODE)process.addListener('uncaughtException',a);else if(p.BROWSER)window.onerror=a;if(b!==false)this.klass.handlers.push(a);return a},_w:function(a){var b=this.klass.handlers,c=b[b.length-1];if(!c)return;if(p.NODE)process.removeListener('uncaughtException',c);else if(p.BROWSER)window.onerror=null;if(a!==false){b.pop();this._1a(b[b.length-1],false)}},_19:function(b){return function(a){if(h.isType(a,f.Unit.AssertionFailedError))this.addFailure(a.message);else this.addError(a);if(b)b.call(this)}},_18:function(a,b,c){try{a.call(this)}catch(e){if(b)b.call(this,e)}finally{if(c)c.call(this)}},setup:function(a){a()},teardown:function(a){a()},defaultTest:function(){return this.flunk('No tests were specified')},passed:function(){return this._1},size:function(){return 1},addAssertion:function(){this._N.addAssertion()},addFailure:function(a){this._1=false;this._N.addFailure(new f.Unit.Failure(this,a))},addError:function(a){this._1=false;this._N.addError(new f.Unit.Error(this,a))},metadata:function(){var a=this.klass.metadata(),b=this._4.replace(/^test:\W*/ig,'');return{fullName:a.fullName+' '+b,shortName:b,context:a.context.concat(a.shortName),size:this.size()}}})});f.UI.extend({Terminal:new h.Class({OPTIONS:{format:String,test:Array},SHORTS:{'f':'--format','t':'--test'},getOptions:function(){var a={},b=p.envvar('FORMAT'),c=p.envvar('TEST'),d;if(p.envvar('TAP'))a.format='tap';if(b)a.format=b;if(c)a.test=[c];if(p.NODE){try{d=require('nopt')}catch(e){}if(d)h.extend(a,d(this.OPTIONS,this.SHORTS))}delete a.argv;a.test=a.test||[];return a},getReporters:function(a){var b=f.Reporters,c=b.get(a.format)||b.Dot;return[new b.Coverage(a),new c(a),new b.ExitStatus(a)]}})});f.UI.extend({Browser:new h.Class({getOptions:function(){var a=(location.search||'').replace(/^\?/,''),b=a.split('&'),c={},d,g,j;for(var k=0,m=b.length;k<m;k++){d=b[k].split('=');g=decodeURIComponent(d[0]);j=decodeURIComponent(d[1]);if(/\[\]$/.test(d[0])){g=g.replace(/\[\]$/,'');if(!(c[g]instanceof Array))c[g]=[];c[g].push(j)}else{c[g]=j}}if(c.test)c.test=[].concat(c.test);else c.test=[];return c},getReporters:function(a){var b=[],c=f.Reporters,d=new c.Browser(a),g;b.push(new c.Coverage());b.push(d);for(var j in c){g=c[j]&&c[j].create&&c[j].create(a,d);if(g)b.push(g)}return b}})});f.Reporters.extend({Error:new h.Class({include:p,NAMES:{failure:'Failure',error:'Error'},startSuite:function(a){this._0=[];this._7=a.timestamp;this.consoleFormat('bold');this.puts('Loaded suite: '+a.children.join(', '));this.reset();this.puts('')},startContext:function(a){},startTest:function(a){},addFault:function(a){this._0.push(a);this._1b(this._0.length,a)},update:function(a){},endTest:function(a){},endContext:function(a){},endSuite:function(a){this._1c(a)},_1b:function(a,b){this.consoleFormat('bold','red');this.puts(a+') '+this.NAMES[b.error.type]+': '+b.test.fullName);this.reset();this.puts(b.error.message);if(b.error.backtrace)this.puts(b.error.backtrace);this.reset();this.puts('')},_1c:function(a){var b=(a.timestamp-this._7)/1000;this.reset();this.puts('Finished in '+b+' seconds');var c=a.passed?'green':'red';this.consoleFormat(c);this.puts(this._x(a.tests,'test')+', '+this._x(a.assertions,'assertion')+', '+this._x(a.failures,'failure')+', '+this._x(a.errors,'error'));this.reset();this.puts('')},_x:function(a,b){return a+' '+b+(a===1?'':'s')}})});f.Reporters.register('error',f.Reporters.Error);f.Reporters.extend({Dot:new h.Class(f.Reporters.Error,{SYMBOLS:{failure:'F',error:'E'},startTest:function(a){this._O=false},addFault:function(a){this._0.push(a);if(this._O)return;this._O=true;this.consoleFormat('bold','red');this.print(this.SYMBOLS[a.error.type]);this.reset()},endTest:function(a){if(this._O)return;this.consoleFormat('green');this.print('.');this.reset()},endSuite:function(a){this.puts('\n');for(var b=0,c=this._0.length;b<c;b++)this._1b(b+1,this._0[b]);this._1c(a)}})});f.Reporters.register('dot',f.Reporters.Dot);f.Reporters.extend({Progress:new h.Class(f.Reporters.Dot,{extend:{CACHE_TIME:1000},startSuite:function(a){if(!p.coloring())throw new Error('Cannot use the progress reporter; terminal formatting is not available');this._2=[];this._0=[];this._7=a.timestamp;this._1A=a.size;this._y='|';this._z=' ';this._q=[''];var b=10;while(b--){this._z=this._z+this._z;this._y=this._y+this._y;}this.puts('\n\n\n');this.cursorHide();},startTest:function(a){this._2.push(a);var b=a.fullName.split(/\s+/),c=this._1d()-10,d=[],g='';while(b.length>0){while(b[0]&&g.length+b[0].length+1<=c)g+=b.shift()+' ';if(b[0]){d.push(g);g='';}}d.push(g);while(d.length<this._q.length)d.push('');this._1B=d;this._P();},endTest:function(a){},addFault:function(a){this._0.push(a);this._P();},endSuite:function(a){this._1e=a.passed;this._P();this.cursorPrevLine(2);this.cursorShow();this.callSuper();},_P:function(){var a=this._1d(),b=this._2.length/this._1A,c=this._2[this._2.length-1],d=Math.floor(a*b),g=String(Math.floor(100*b)),j,k,m;this.cursorPrevLine(2+this._q.length);this.reset();this.print('  ');if(this._0.length>0)this.red();else if(this._1e)this.green();else this.cyan();this.bold();this.puts(this._y.substr(0,d));this.reset();if(this._1e!==undefined){this.eraseScreenForward();return this.puts('');}while(g.length<2)g=' '+g;g='['+g+'%]';this.cursorForward(2+a-g.length);this.puts(g);this.cursorPrevLine(1);this._q=this._1B;for(k=0,m=this._q.length;k<m;k++){j=this._q[k];this.puts('  '+j+this._z.substr(0,a-j.length-10));}this.puts('');},_1d:function(){var a=new h.Date().getTime();if(this._1f&&a<this._1C+this.klass.CACHE_TIME)return this._1f;this._1C=new h.Date().getTime();return this._1f=p.getDimensions()[0]-8;}})});f.Reporters.register('progress',f.Reporters.Progress);f.Reporters.extend({Spec:new h.Class(f.Reporters.Dot,{extend:{TICK:'\u2713',CROSS:'\u2717'},startSuite:function(a){this._0=[];this._7=a.timestamp;this._5=[];this.puts('');},startContext:function(a){if(a.context===null)return;this.puts(this._h(this._5.length)+a.shortName);this._5.push(a.shortName);},startTest:function(a){this._1=true;},addFault:function(a){this._0.push(a);this._1=false;},endTest:function(a){var b=this._h(this._5.length),c=this._1?'green':'red',d=this._1?this.klass.TICK:this.klass.CROSS,g=this._1?'':' ('+this._0.length+')';this.consoleFormat(c);this.puts(b+d+g+' '+a.shortName);this.reset();},endContext:function(a){if(a.context===null)return;this._5.pop();},_h:function(a){var b='';while(a--)b+='  ';return b;}})});f.Reporters.register('spec',f.Reporters.Spec);f.Reporters.extend({XML:new h.Class({include:p,startSuite:function(a){this._0=[];this._5=[];this._8=[];this.puts('<?xml version="1.0" encoding="UTF-8" ?>');this.puts('<testsuites>');},startContext:function(a){if(a.context===null)return;if(this._5.length===0)this._8.push({name:a.shortName,cases:[],tests:0,failures:0,errors:0,start:a.timestamp});this._5.push(a.shortName);},startTest:function(a){this._8[this._8.length-1].cases.push({name:a.context.slice(1).concat(a.shortName).join(' '),start:a.timestamp,failures:[]});},addFault:function(a){var b=this._8[this._8.length-1],c=b.cases[b.cases.length-1];if(a.error.type==='failure'){b.failures+=1;c.failures.push({type:'Failure',error:a.error});}else if(a.error.type==='error'){b.errors+=1;c.failures.push({type:'Error',error:a.error});}},endTest:function(a){var b=this._8[this._8.length-1],c=b.cases[b.cases.length-1];c.time=(a.timestamp-c.start)/1000;delete c.start;},endContext:function(a){this._5.pop();if(this._5.length>0)return;var b=this._8[this._8.length-1];b.time=(a.timestamp-b.start)/1000;delete b.start;var c,d,g,j,k,m,l;this.puts('    <testsuite name="'+this._r(b.name)+'" tests="'+b.cases.length+'" failures="'+b.failures+'" errors="'+b.errors+'" time="'+b.time+'">');for(j=0,l=b.cases.length;j<l;j++){c=b.cases[j];g=(c.failures.length===0)?' />':'>';this.puts('        <testcase classname="'+this._r(b.name)+'" name="'+this._r(c.name)+'" time="'+c.time+'"'+g);for(k=0,m=c.failures.length;k<m;k++){d=c.failures[k];g=d.error.backtrace?'>':' />';this.puts('            <failure type="'+d.type+'" message="'+this._r(d.error.message)+'"'+g);if(d.error.backtrace){this._1D(d.error.backtrace);this.puts('            </failure>');}}if(c.failures.length>0)this.puts('        </testcase>');}this.puts('    </testsuite>');},update:function(a){},endSuite:function(a){this.puts('</testsuites>');},_r:function(a){return a.replace(/[\s\t\r\n]+/g,' ').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');},_1D:function(a){var b=a.replace(/^\s*|\s*$/g,'').split(/\s*[\r\n]+\s*/);for(var c=0,d=b.length;c<d;c++){this.puts('                '+this._r(b[c]));}}})});f.Reporters.register('xml',f.Reporters.XML);f.Reporters.register('junit',f.Reporters.XML);f.Reporters.extend({JSON:new h.Class({include:p,_1E:function(a,b){if(!h.ENV.JSON)return;this.puts(JSON.stringify({jstest:[a,b]}));},extend:{create:function(){if(!h.ENV.navigator)return;if(/\bPhantomJS\b/.test(navigator.userAgent))return new this();},Reader:new h.Class({initialize:function(a){this._3=a;},read:function(a){if(!h.ENV.JSON)return false;try{var b=JSON.parse(a),c=b.jstest,d=c[0],g=c[1];this._3[d](g);return true;}catch(e){return false;}}})}})});(function(){var b=f.Reporters.METHODS,c=b.length;while(c--)(function(i){var d=b[i];f.Reporters.JSON.define(d,function(a){this._1E(d,a);});})(c);})();f.Reporters.register('json',f.Reporters.JSON);f.Reporters.extend({TAP:new h.Class({extend:{HOSTNAME:'testling',create:function(a){if(!h.ENV.location)return;var b=location.hostname.split('.');if(h.indexOf(b,this.HOSTNAME)>=0)return new this(a);}},include:p,startSuite:function(a){this._s=0;this.puts('1..'+a.size);},startContext:function(a){},startTest:function(a){this._1=true;this._0=[];},addFault:function(a){this._1=false;this._0.push(a);},endTest:function(a){var b=this._1?'ok':'not ok';b+=' '+ ++this._s+' - '+this._1F(a.fullName);this.puts(b);var c,d,g,j,k;for(var m=0,l=this._0.length;m<l;m++){c=this._0[m];var d=c.error.message;if(c.error.backtrace)d+='\n'+c.error.backtrace;g=d.split(/[\r\n]/);for(j=0,k=g.length;j<k;j++)this.puts('    '+g[j]);}},endContext:function(a){},update:function(a){},endSuite:function(a){},_1F:function(a){return a.replace(/[\s\t\r\n]+/g,' ');}})});f.Reporters.register('tap',f.Reporters.TAP);f.Reporters.extend({TAP_YJ:new h.Class({STATUSES:{failure:'fail',error:'error'},startSuite:function(a){this._A({type:'suite',start:this._1G(),count:a.size,rev:2});this._7=a.timestamp;},startContext:function(a){this._A({type:'case',label:a.shortName,level:a.context.length});},startTest:function(a){this._0=[];this._Q=null;},addFault:function(a){this._0.push(a);this._Q=this._Q||this.STATUSES[a.error.type];},endTest:function(a){var b={type:'test',status:this._Q||'pass',label:a.shortName,time:this._1g(a.timestamp)};var c=this._0[0];if(c)b.exception={message:c.error.message,backtrace:c.error.backtrace?c.error.backtrace.split('\n'):[]};this._A(b);},endContext:function(a){},update:function(a){},endSuite:function(a){this._A({type:'final',time:this._1g(a.timestamp),counts:{total:a.tests,pass:a.tests-a.failures-a.errors,fail:a.failures,error:a.errors}});},_1g:function(a){return(a-this._7)/1000;},_A:function(a){p.puts(this._B(a));},_1G:function(){var a=new h.Date(),b=a.getFullYear(),c=this._t(a.getMonth()+1),d=this._t(a.getDay()),g=this._t(a.getHours()),j=this._t(a.getMinutes()),k=this._t(a.getSeconds());return b+'-'+c+'-'+d+' '+g+':'+j+':'+k;},_t:function(a){var b=a.toString();while(b.length<2)b='0'+b;return b;}})});f.Reporters.extend({TAP_YAML:new h.Class(f.Reporters.TAP_YJ,{_B:function(a,b){b=b||0;var c='';if(b===0)c='---';if(a instanceof Array)c+=this._1H(a,b);else if(typeof a==='object')c+=this._9(a,b);else if(typeof a==='string')c+=this._1I(a,b);else if(typeof a==='number')c+=this._1J(a,b);return c;},_1H:function(a,b){if(a.length===0)return'[]';var c='',d=this._h(b);for(var g=0,j=a.length;g<j;g++){c+='\n'+d+'- '+this._B(a[g],b+1);}return c;},_9:function(a,b){var c='',d=this._h(b);for(var g in a){if(!a.hasOwnProperty(g))continue;c+='\n'+d+g+': '+this._B(a[g],b+1);}return c;},_1I:function(a,b){if(!/[\r\n]/.test(a))return'"'+a.replace(/"/g,'\\"')+'"';var c=a.split(/\r\n?|\n/),d='|',g=this._h(b);for(var j=0,k=c.length;j<k;j++){d+='\n'+g+c[j]}return d},_1J:function(a,b){return a.toString()},_h:function(a){var b='';while(a--)b+='  ';return b}}),TAP_JSON:new h.Class(f.Reporters.TAP_YJ,{_B:function(a){return h.ENV.JSON?JSON.stringify(a):''}})});var s=f.Reporters;s.register('tap/yaml',s.TAP_YAML);s.register('tap/y',s.TAP_YAML);s.register('tap-yaml',s.TAP_YAML);s.register('tap-y',s.TAP_YAML);s.register('tap/json',s.TAP_JSON);s.register('tap/j',s.TAP_JSON);s.register('tap-json',s.TAP_JSON);s.register('tap-j',s.TAP_JSON);f.Reporters.extend({ExitStatus:new h.Class({startSuite:function(a){},startContext:function(a){},startTest:function(a){},addFault:function(a){},endTest:function(a){},endContext:function(a){},update:function(a){},endSuite:function(a){p.exit(a.passed?0:1)}})});f.Reporters.extend({PhantomJS:new h.Class({initialize:function(b,c){this._a=b||{};var d=p.envvar('FORMAT');if(p.envvar('TAP'))d=d||'tap';this._a.format=this._a.format||d;var g=f.Reporters,j=g.get(this._a.format)||g.Dot,k=new g.Composite(),m=new g.JSON.Reader(k);k.addReporter(new j(b));k.addReporter(new g.ExitStatus());c.onConsoleMessage=function(a){if(!m.read(a))console.log(a)}}})});f.Reporters.extend({Browser:new h.Class({initialize:function(a){this._a=a||{}},_1h:function(a){var b=this._1K,c=a.context;for(var d=0,g=c.length;d<g;d++)b=b.child(c[d]);return b},startSuite:function(g){var j=this;if(this._R)document.body.removeChild(this._R);this._7=g.timestamp;this._R=u.div({className:'test-result-container'},function(d){d.table({className:'report'},function(c){c.thead(function(b){b.tr(function(a){a.th({scope:'col'},'Tests');a.th({scope:'col'},'Assertions');a.th({scope:'col'},'Failures');a.th({scope:'col'},'Errors')})});c.tbody(function(b){b.tr(function(a){j._2=a.td();j._1L=a.td();j._e=a.td();j._o=a.td()})})});j._1i=d.div({className:'light light-pending'});d.p({className:'user-agent'},window.navigator.userAgent);j._1K=new j.klass.Context('spec',d.ul({className:'specs'}),undefined,j._a);j._1M=d.p({className:'summary'})});document.body.insertBefore(this._R,document.body.firstChild);this.update({tests:0,assertions:0,failures:0,errors:0})},startContext:function(a){},startTest:function(a){this._1h(a).addTest(a.shortName)},addFault:function(a){this._1h(a.test).child(a.test.shortName).addFault(a.error)},endTest:function(a){},endContext:function(a){},update:function(a){this._2.innerHTML=String(a.tests);this._1L.innerHTML=String(a.assertions);this._e.innerHTML=String(a.failures);this._o.innerHTML=String(a.errors)},endSuite:function(a){this.update(a);u.removeClass(this._1i,'light-pending');u.addClass(this._1i,a.passed?'light-passed':'light-failed');var b=(a.timestamp-this._7)/1000;this._1M.innerHTML='Finished in '+b+' seconds'},serialize:function(){var a=document.getElementsByTagName('li'),b=a.length;while(b--)u.removeClass(a[b],'closed');var a=document.getElementsByTagName('script'),b=a.length;while(b--)a[b].parentNode.removeChild(a[b]);var c=document.getElementsByTagName('html')[0];return'<!doctype html><html>'+c.innerHTML+'</html>'}})});f.Reporters.Browser.extend({Context:new h.Class({initialize:function(g,j,k,m){this._b=j;this._c=g;this._1N=k;this._a=m;this._S=[];if(k===undefined){this._T=j;return}var l=this._b._T||this._b,o={_2:'Tests',_e:'Failed'},n=this;this._C=new u.Builder(l).li({className:this._c+' passed'},function(d){d.ul({className:'stats'},function(b){for(var c in o)b.li(function(a){a.span({className:'label'},o[c]+': ');n[c]=a.span({className:'number'},'0')})});if(k){n._D=d.p({className:n._c+'-name'},k);if(n._c==='spec'){n._U=u.span({className:'runner'},'Run');n._D.insertBefore(n._U,n._D.firstChild)}}n._T=d.ul({className:'children'})});var q=this._a.test||[];if(q.length===0)u.addClass(this._C,'closed');u.Event.on(this._D,'click',function(){u.toggleClass(this._C,'closed')},this);if(this._U)u.Event.on(this._U,'click',this.runTest,this)},ping:function(a){if(!this[a])return;this[a].innerHTML=parseInt(this[a].innerHTML)+1;if(this._b.ping)this._b.ping(a)},fail:function(){if(!this._C)return;u.removeClass(this._C,'passed');u.addClass(this._D,'failed');if(this._b.fail)this._b.fail()},child:function(a){return this._S[a]=this._S[a]||new this.klass('spec',this,a,this._a)},addTest:function(a){var b=this._S[a]=new this.klass('test',this,a,this._a);b.ping('_2')},addFault:function(j){var k=j.message;if(j.backtrace)k+='\n'+j.backtrace;var m=u.li({className:'fault'},function(g){g.p(function(a){var b=k.split(/[\r\n]+/);for(var c=0,d=b.length;c<d;c++){if(c>0)a.br();a.concat(b[c])}})});this._T.appendChild(m);this.ping('_e');this.fail()},getName:function(){var a=[],b=this._b&&this._b.getName&&this._b.getName();if(b)a.push(b);a.push(this._1N);return a.join(' ')},runTest:function(){window.location.search='test='+encodeURIComponent(this.getName())}})});f.Reporters.extend({Buster:new h.Class({extend:{create:function(a){if(h.ENV.buster)return new this(a)}},startSuite:function(a){this._1j=0;this._5=[];buster.emit('suite:start')},startContext:function(a){if(a.context===null)return;this._1j+=1;buster.emit('context:start',{name:a.shortName})},startTest:function(a){this._1=true;buster.emit('test:start',{name:a.shortName})},addFault:function(a){if(!this._1)return;this._1=false;if(a.error.type==='failure'){buster.emit('test:failure',{name:a.test.shortName,error:{message:a.error.message}})}else{buster.emit('test:error',{name:a.test.shortName,error:{message:a.error.message,stack:a.error.backtrace}})}},endTest:function(a){if(!this._1)return;buster.emit('test:success',{name:a.shortName})},endContext:function(a){if(a.context===null)return;buster.emit('context:end',{name:a.fullName})},update:function(a){},endSuite:function(a){buster.emit('suite:end',{ok:a.passed,contexts:this._1j,tests:a.tests,assertions:a.assertions,failures:a.failures,errors:a.errors,timeouts:0})}})});f.Reporters.extend({Karma:new h.Class({extend:{create:function(a){if(h.ENV.__karma__)return new this(a)}},initialize:function(a){this._V=h.ENV.__karma__;this._s=0},startSuite:function(a){this._V.info({total:a.size})},startContext:function(a){},startTest:function(a){this._0=[];this._7=a.timestamp},addFault:function(a){var b=a.error.message;if(a.error.backtrace)b+='\n'+a.error.backtrace;this._0.push(b)},endTest:function(a){this._V.result({id:++this._s,description:a.shortName,suite:a.context,success:this._0.length===0,skipped:0,time:a.timestamp-this._7,log:this._0})},endContext:function(a){},update:function(a){},endSuite:function(a){this._V.complete()}})});f.Reporters.extend({Teabag:new h.Class({extend:{Spec:new h.Class({initialize:function(a){this._W=a;this.fullDescription=a.event.fullName;this.description=a.event.shortName;this.parent=f.Reporters.Teabag.Suite.find(a.event.context);this.link='?grep='+encodeURIComponent(this.fullDescription)},errors:function(){var a=[],b=this._W.faults;for(var c=0,d=b.length;c<d;c++){a.push(b[c].error)}return a},getParents:function(){if(this._E)return this._E;this._E=[];var a=this._W.event.context;for(var b=1,c=a.length;b<c;b++){this._E.push(f.Reporters.Teabag.Suite.find(a.slice(0,b)))}return this._E},result:function(){var a='passed';if(this._W.faults.length>0)a='failed';return{status:a,skipped:false}}}),Suite:new h.Class({extend:{_1k:{},find:function(a){var b=a.join('~');if(b==='')return null;return this._1k[b]=this._1k[b]||{context:a}}},initialize:function(a){var b=a.context;this.fullDescription=b.join(' ');this.description=b[b.length-1];this.parent=this.klass.find(b.slice(0,b.length-1));this.link='?grep='+encodeURIComponent(this.fullDescription)}})},initialize:function(a,b){this._u=b},startSuite:function(a){this._u.reportRunnerStarting({total:a.size})},startContext:function(a){},startTest:function(a){this._0=[];if(this._u.reportSpecStarting)this._u.reportSpecStarting({event:a,faults:this._0})},addFault:function(a){a.error.stack=a.error.backtrace;this._0.push(a)},endTest:function(a){this._u.reportSpecResults({event:a,faults:this._0})},endContext:function(a){},update:function(a){},endSuite:function(a){this._u.reportRunnerResults()}})});(function(){if(!h.ENV.Teabag)return;Teabag.Reporters.HTML.prototype.envInfo=function(){return'jstest'};Teabag.Runner.prototype.setup=function(){var b={};if(Teabag.params.grep)b.test=[Teabag.params.grep];var c=this.getReporter(),d=new f.Reporters.Teabag({},new c());f.autorun(b,function(a){a.setReporter(d)})};Teabag.Spec=f.Reporters.Teabag.Spec;Teabag.Suite=f.Reporters.Teabag.Suite})();f.Reporters.extend({Testem:new h.Class({extend:{SCRIPT_URL:'/testem.js',prepare:function(a,b){if(!h.ENV.location)return a.call(b||null);var c=(location.hash||'').replace(/^#/,'');if(c!=='testem')return a.call(b||null);h.load(this.SCRIPT_URL,function(){a.call(b||null)})},create:function(a){if(h.ENV.Testem)return new this(a)}},initialize:function(){var b=this;Testem.useCustomAdapter(function(a){b._X=a})},startSuite:function(a){this._1l=[];this._s=0;this._X.emit('tests-start')},startContext:function(a){},startTest:function(a){this._1=true;this._0=[]},addFault:function(a){this._1=false;this._0.push({passed:false,message:a.error.message,stacktrace:a.error.backtrace})},endTest:function(a){var b={passed:this._1?1:0,failed:this._1?0:1,total:1,id:++this._s,name:a.fullName,items:this._0};this._1l.push(b);this._X.emit('test-result',b)},endContext:function(a){},update:function(a){},endSuite:function(a){this._X.emit('all-test-results',{passed:a.tests-a.failures-a.errors,failed:a.failures,total:a.tests,tests:this._1l})}})});f.Reporters.extend({TestSwarm:new h.Class({extend:{create:function(a,b){if(h.ENV.TestSwarm)return new this(a,b)}},initialize:function(a,b){this._1T=b;TestSwarm.serialize=function(){return b.serialize()}},startSuite:function(a){},startContext:function(a){},startTest:function(a){},addFault:function(a){},endTest:function(a){TestSwarm.heartbeat()},endContext:function(a){},update:function(a){},endSuite:function(a){TestSwarm.submit({fail:a.failures,error:a.errors,total:a.tests})}})});f.Reporters.extend({Coverage:new h.Class({include:p,startSuite:function(a){},startContext:function(a){},startTest:function(a){},addFault:function(a){},endTest:function(a){},endContext:function(a){},update:function(a){},endSuite:function(a){var b=f.Unit.TestCase.reports;for(var c=0,d=b.length;c<d;c++){this.reset();this.puts('');b[c].report()}}})});f.Reporters.extend({Composite:new h.Class({initialize:function(a){this._i=a||[]},addReporter:function(a){if(!a)return;this._i.push(a)},removeReporter:function(a){var b=h.indexOf(this._i,a);if(b>=0)this._i.splice(b,1)}})});(function(){var g=f.Reporters.METHODS,j=g.length;while(j--)(function(i){var k=g[i];f.Reporters.Composite.define(k,function(a){var b;for(var c=0,d=this._i.length;c<d;c++){b=this._i[c][k];if(b)b.call(this._i[c],a)}})})(j)})();f.extend({Context:new h.Module({extend:{included:function(a){a.extend(f.Context.Context,{_j:false});a.include(f.Context.LifeCycle,{_j:false});a.extend(f.Context.Test,{_j:false});a.include(p)},Context:new h.Module({context:function(a,b){var c=new h.Class(a.toString(),this,{},{_j:false});c.__eigen__().resolve();b.call(c);return c},cover:function(a){var b=new f.Coverage(a);this.before_all_callbacks.push(b.method('attach'));this.after_all_callbacks.push(b.method('detach'));f.Unit.TestCase.reports.push(b)}})}}),describe:function(a,b){var c=new h.Class(a.toString(),f.Unit.TestCase,{},{_j:false});c.include(f.Context,{_j:false});c.__eigen__().resolve();b.call(c);return c}});f.Context.Context.alias({describe:'context'});f.extend({context:f.describe});f.Context.LifeCycle=new h.Module({extend:{included:function(b){b.extend(this.ClassMethods);b.before_all_callbacks=[];b.before_each_callbacks=[];b.after_all_callbacks=[];b.after_each_callbacks=[];b.before_should_callbacks={};b.extend({inherited:function(a){this.callSuper();a.before_all_callbacks=[];a.before_each_callbacks=[];a.after_all_callbacks=[];a.after_each_callbacks=[];a.before_should_callbacks={}}})},ClassMethods:new h.Module({before:function(a,b){if((typeof a==='function')||!b){b=a;a='each'}this['before_'+(a+'_')+'callbacks'].push(b)},after:function(a,b){if((typeof a==='function')||!b){b=a;a='each'}this['after_'+(a+'_')+'callbacks'].push(b)},gatherCallbacks:function(a,b){var c=(typeof this.superclass.gatherCallbacks==='function')?this.superclass.gatherCallbacks(a,b):[];var d=this[a+'_'+(b+'_')+'callbacks'];return(a==='before')?c.concat(d):d.concat(c)}})},setup:function(a){var b=this;this.callSuper(function(){if(b.klass.before_should_callbacks[b._4])b.klass.before_should_callbacks[b._4].call(b);b.runCallbacks('before','each',a)})},teardown:function(a){var b=this;this.callSuper(function(){b.runCallbacks('after','each',a)})},runCallbacks:function(c,d,g){var j=this.klass.gatherCallbacks(c,d);f.Unit.TestSuite.forEach(j,function(a,b){this.exec(a,b)},g,this)},runAllCallbacks:function(d,g,j){var k=this.instanceVariables();this.runCallbacks(d,'all',function(){var c=this.instanceVariables().inject({},function(a,b){if(k.member(b))return a;a[b]=this[b];return a},this);if(g)g.call(j||null,c)})},setValuesFromCallbacks:function(a){for(var b in a)this[b]=a[b]},instanceVariables:function(){var a=[];for(var b in this){if(this.hasOwnProperty(b))a.push(b)}return new t.Collection(a)}});(function(){var a=f.Context.LifeCycle.ClassMethods.method('instanceMethod');f.Context.LifeCycle.ClassMethods.include({setup:a('before'),teardown:a('after')})})();f.Context.extend({SharedBehavior:new h.Class(h.Module,{extend:{createFromBehavior:function(a){var b=new this();b._1O=a;return b},moduleName:function(c){return c.toLowerCase().replace(/[\s:',\.~;!#=\(\)&]+/g,'_').replace(/\/(.?)/g,function(a,b){return'.'+b.toUpperCase()}).replace(/(?:^|_)(.)/g,function(a,b){return b.toUpperCase()})}},included:function(a){this._1O.call(a)}})});f.Unit.TestCase.extend({shared:function(a,b){a=f.Context.SharedBehavior.moduleName(a);h.ENV[a]=f.Context.SharedBehavior.createFromBehavior(b)},use:function(a){if(h.isType(a,f.Context.SharedBehavior)||h.isType(a,h.Module))this.include(a);else if(h.isType(a,'string')){var b=f.Context.SharedBehavior.moduleName(a),c=h.ENV[b];if(!c)throw new Error('Could not find example group named "'+a+'"');this.include(c)}}});(function(){var j=function(a,b){var c={};for(var d=0,g=b.length;d<g;d++)c[b[d]]=f.Unit.TestCase[a];f.Unit.TestCase.extend(c)};j('shared',['sharedBehavior','shareAs','shareBehaviorAs','sharedExamplesFor']);j('use',['uses','itShouldBehaveLike','behavesLike','usesExamplesFrom'])})();f.Context.Test=new h.Module({test:function(a,b,c){var d='test: '+a;if(h.indexOf(this.instanceMethods(false),d)>=0)throw new Error(d+' is already defined in '+this.displayName);b=b||{};if(typeof b==='function'){c=b}else{if(b.before!==undefined)this.before_should_callbacks[d]=b.before}this.define(d,c,{_j:false})},beforeTest:function(a,b){this.test(a,{before:b},function(){})}});f.Context.Test.alias({it:'test',should:'test',tests:'test',beforeIt:'beforeTest',beforeShould:'beforeTest',beforeTests:'beforeTest'});(function(){var b=f.Unit.TestCase.suite;f.Unit.TestCase.extend({suite:function(a){return b.call(this,a,false,false)}})})();f.Unit.TestSuite.include({run:function(d,g,j,k){if(this._p.fullName)j.call(k||null,this.klass.STARTED,this);var m=function(c){this.forEach(function(a,b){if(c&&a.setValuesFromCallbacks)a.setValuesFromCallbacks(c);a.run(d,b,j,k)},function(){var a=function(){if(this._p.fullName)j.call(k||null,this.klass.FINISHED,this);g.call(k||null)};if(c&&l.runAllCallbacks)l.runAllCallbacks('after',a,this);else a.call(this)},this)};var l=this._2[0],o=null;if(l&&l.runAllCallbacks)l.runAllCallbacks('before',m,this);else m.call(this,null)}});f.extend({Mocking:new h.Module({extend:{ExpectationError:new h.Class(f.Unit.AssertionFailedError),UnexpectedCallError:new h.Class(Error,{initialize:function(a){this.message=a.toString()}}),__activeStubs__:[],stub:function(a,b,c){var d=false;if(a==='new'){a=b;b=c;c=undefined;d=true}if(h.isType(a,'string')){c=b;b=a;a=h.ENV}var g=this.__activeStubs__,j=g.length;while(j--){if(g[j]._9===a&&g[j]._4===b)return g[j].defaultMatcher(c)}var k=new f.Mocking.Stub(a,b,d);g.push(k);return k.defaultMatcher(c)},removeStubs:function(){var a=this.__activeStubs__,b=a.length;while(b--)a[b].revoke();this.__activeStubs__=[]},verify:function(){try{var a=this.__activeStubs__;for(var b=0,c=a.length;b<c;b++)a[b]._1P()}finally{this.removeStubs()}},Stub:new h.Class({initialize:function(a,b,c){this._9=a;this._4=b;this._F=c;this._k=a[b];this._1Q=a.hasOwnProperty?a.hasOwnProperty(b):(typeof this._k!=='undefined');var d=f.Mocking;this._G=[];this._l=new d.Parameters([new d.AnyArgs()]);this._d=false;this.apply()},defaultMatcher:function(a){if(a!==undefined&&typeof a!=='function'){this._9[this._4]=a;return this}this._1m();this._6=this._l;if(typeof a==='function')this._6._1n=a;return this},apply:function(){var a=this._9,b=this._4;if(a[b]!==this._k)return;var c=this;this._1o=function(){return c._1R(this,arguments)};a[b]=this._1o},revoke:function(){if(this._1Q)this._9[this._4]=this._k;else try{delete this._9[this._4]}catch(e){this._9[this._4]=undefined}},expected:function(){this._d=true;this._l._d=true},_1m:function(){if(this._6)this._6._1p=true},_1R:function(a,b){this._1m();var c=this._G.concat(this._l),d,g,j;if(this._F&&!(a instanceof this._1o)){j=new f.Unit.AssertionMessage('','<?> expected to be a constructor but called without `new`',[this._k]);throw new f.Mocking.UnexpectedCallError(j);}this._l.ping();for(var k=0,m=c.length;k<m;k++){d=c[k];g=d.match(b);if(!g)continue;if(d!==this._l)d.ping();if(g.fake)return g.fake.apply(a,b);if(g.exception)throw g.exception;if(g.hasOwnProperty('callback')){if(!g.callback)continue;g.callback.apply(g.context,d.nextYieldArgs())}if(g)return d.nextReturnValue()}if(this._F){j=new f.Unit.AssertionMessage('','<?> constructed with unexpected arguments:\n(?)',[this._k,h.array(b)])}else{j=new f.Unit.AssertionMessage('','<?> received call to '+this._4+'() with unexpected arguments:\n(?)',[a,h.array(b)])}throw new f.Mocking.UnexpectedCallError(j);},_1P:function(){if(!this._d)return;for(var a=0,b=this._G.length;a<b;a++)this._1q(this._G[a]);this._1q(this._l)},_1q:function(a){var b=this._F?this._k:this._9;a.verify(b,this._4,this._F)}})}})});f.Mocking.extend({Parameters:new h.Class({initialize:function(a,b){this._1r=h.array(a);this._d=b;this._1p=false;this._m=0},toArray:function(){var a=this._1r.slice();if(this._n)a.push(new f.Mocking.InstanceOf(Function));return a},returns:function(a){this._Y=0;this._Z=a},nextReturnValue:function(){if(!this._Z)return undefined;var a=this._Z[this._Y];this._Y=(this._Y+1)%this._Z.length;return a},yields:function(a){this._10=0;this._n=a},nextYieldArgs:function(){if(!this._n)return undefined;var a=this._n[this._10];this._10=(this._10+1)%this._n.length;return a},setMinimum:function(a){this._d=true;this._11=a},setMaximum:function(a){this._d=true;this._H=a},setExpected:function(a){this._d=true;this._I=a},match:function(a){if(!this._1p)return false;var b=h.array(a),c,d;if(this._n){if(typeof b[b.length-2]==='function'){d=b.pop();c=b.pop()}else if(typeof b[b.length-1]==='function'){d=null;c=b.pop()}}if(!t.areEqual(this._1r,b))return false;var g={};if(this._g){g.exception=this._g}if(this._n){g.callback=c;g.context=d}if(this._1n){g.fake=this._1n}return g},ping:function(){this._m+=1},verify:function(a,b,c){if(!this._d)return;var d=true,g;if(this._m===0&&this._H===undefined&&this._I===undefined){d=false}else if(this._I!==undefined&&this._m!==this._I){g=this._12('exactly');d=false}else if(this._H!==undefined&&this._m>this._H){g=this._12('at most');d=false}else if(this._11!==undefined&&this._m<this._11){g=this._12('at least');d=false}if(d)return;var j;if(c){j=new f.Unit.AssertionMessage('Mock expectation not met','<?> expected to be constructed with\n(?)'+(g?'\n'+g:''),[a,this.toArray()])}else{j=new f.Unit.AssertionMessage('Mock expectation not met','<?> expected to receive call\n'+b+'(?)'+(g?'\n'+g:''),[a,this.toArray()])}throw new f.Mocking.ExpectationError(j);},_12:function(a){var b=this._m,c='but '+b+' call'+(b===1?' was':'s were')+' made';var d={'exactly':this._I,'at most':this._H,'at least':this._11};return a+' '+d[a]+' times\n'+c}})});f.Mocking.extend({Anything:new h.Class({equals:function(){return true},toString:function(){return'anything'}}),AnyArgs:new h.Class({equals:function(){return t.ALL_EQUAL},toString:function(){return'*arguments'}}),ArrayIncluding:new h.Class({initialize:function(a){this._f=Array.prototype.slice.call(a)},equals:function(a){if(!h.isType(a,Array))return false;var b=this._f.length,c;loop:while(b--){c=a.length;while(c--){if(t.areEqual(this._f[b],a[c]))continue loop}return false}return true},toString:function(){var a=p.convert(this._f);return'arrayIncluding('+a+')'}}),ObjectIncluding:new h.Class({initialize:function(a){this._f=a},equals:function(a){if(!h.isType(a,Object))return false;for(var b in this._f){if(!t.areEqual(this._f[b],a[b]))return false}return true},toString:function(){var a=p.convert(this._f);return'objectIncluding('+a+')'}}),InstanceOf:new h.Class({initialize:function(a){this._c=a},equals:function(a){return h.isType(a,this._c)},toString:function(){var a=p.convert(this._c),b=/^[aeiou]/i.test(a)?'an':'a';return b+'('+a+')'}}),Matcher:new h.Class({initialize:function(a){this._c=a},equals:function(a){return h.match(this._c,a)},toString:function(){var a=p.convert(this._c);return'matching('+a+')'}})});f.Mocking.Stub.include({given:function(){var a=new f.Mocking.Parameters(arguments,this._d);this._G.push(a);this._6=a;return this},raises:function(a){this._6._g=a;return this},returns:function(){this._6.returns(arguments);return this},yields:function(){this._6.yields(arguments);return this},atLeast:function(a){this._6.setMinimum(a);return this},atMost:function(a){this._6.setMaximum(a);return this},exactly:function(a){this._6.setExpected(a);return this}});f.Mocking.Stub.alias({raising:'raises',returning:'returns',yielding:'yields'});f.Mocking.extend({DSL:new h.Module({stub:function(){return f.Mocking.stub.apply(f.Mocking,arguments)},expect:function(){var a=f.Mocking.stub.apply(f.Mocking,arguments);a.expected();this.addAssertion();return a},anything:function(){return new f.Mocking.Anything()},anyArgs:function(){return new f.Mocking.AnyArgs()},instanceOf:function(a){return new f.Mocking.InstanceOf(a)},match:function(a){return new f.Mocking.Matcher(a)},arrayIncluding:function(){return new f.Mocking.ArrayIncluding(arguments)},objectIncluding:function(a){return new f.Mocking.ObjectIncluding(a)}})});f.Unit.TestCase.include(f.Mocking.DSL);f.Unit.mocking=f.Mocking;f.extend({AsyncSteps:new h.Class(h.Module,{define:function(b,c){this.callSuper(b,function(){var a=[b,c].concat(h.array(arguments));this.__enqueue__(a)})},included:function(d){d.include(f.AsyncSteps.Sync);if(!d.includes(f.Context))return;d.after(function(a){this.sync(a)});d.extend({after:function(b,c){if((typeof b==='function')||!c){c=b;b='each'}this.callSuper(function(a){this.sync(function(){this.exec(c,a)})})}})},extend:{Sync:new h.Module({__enqueue__:function(a){this.__stepQueue__=this.__stepQueue__||[];this.__stepQueue__.push(a);if(this.__runningSteps__)return;this.__runningSteps__=true;var b=f.FakeClock.REAL.setTimeout;b(this.method('__runNextStep__'),1)},__runNextStep__:function(){var a=this.__stepQueue__.shift(),b;if(!a){this.__runningSteps__=false;if(!this.__stepCallbacks__)return;b=this.__stepCallbacks__.length;while(b--)this.__stepCallbacks__.shift().call(this);return}var c=a.shift(),d=a.shift(),g=a.slice(),j=function(){d.apply(this,g)};g[d.length-1]=this.method('__runNextStep__');if(!this.exec)return j.call(this);this.exec(j,function(){},this.method('__endSteps__'))},__endSteps__:function(){this.__stepQueue__=[];this.__runNextStep__()},addError:function(){this.callSuper();this.__endSteps__()},sync:function(a){if(!this.__runningSteps__)return a.call(this);this.__stepCallbacks__=this.__stepCallbacks__||[];this.__stepCallbacks__.push(a)}})}}),asyncSteps:function(a){return new this.AsyncSteps(a)}});f.extend({FakeClock:new h.Module({extend:{API:new h.Singleton({METHODS:['Date','setTimeout','clearTimeout','setInterval','clearInterval'],stub:function(){var a=f.Mocking,b=this.METHODS,c=b.length;f.FakeClock.reset();while(c--)a.stub(b[c],f.FakeClock.method(b[c]));Date.now=f.FakeClock.REAL.Date.now},reset:function(){return f.FakeClock.reset()},tick:function(a){return f.FakeClock.tick(a)}}),REAL:{},Schedule:new h.Class(z,{nextScheduledAt:function(b){return this.find(function(a){return a.time<=b})}}),Timeout:new h.Class({include:h.Comparable,initialize:function(a,b,c){this.callback=a;this.interval=b;this.repeat=c},compareTo:function(a){return this.time-a.time},toString:function(){return(this.repeat?'Interval':'Timeout')+'('+this.interval+'):'+this.time}}),reset:function(){this._J=new Date().getTime();this._K=this._J;this._v=new this.Schedule()},tick:function(a){this._J+=a;var b;while(b=this._v.nextScheduledAt(this._J))this._1S(b);this._K=this._J},_1S:function(a){this._K=a.time;a.callback();if(a.repeat){a.time+=a.interval;this._v.rebuild()}else{this.clearTimeout(a)}},_1s:function(a,b,c){var d=new this.Timeout(a,b,c);d.time=this._K+b;this._v.add(d);return d},Date:function(){var a=new f.FakeClock.REAL.Date();a.setTime(this._K);return a},setTimeout:function(a,b){return this._1s(a,b,false)},setInterval:function(a,b){return this._1s(a,b,true)},clearTimeout:function(a){this._v.remove(a)},clearInterval:function(a){this._v.remove(a)}}})});f.FakeClock.include({clock:f.FakeClock.API});(function(){var a=f.FakeClock.API.METHODS,b=a.length;while(b--)f.FakeClock.REAL[a[b]]=h.ENV[a[b]]})();f.extend({Coverage:new h.Class({initialize:function(d){this._1t=d;this._L=new B([]);var g=function(a){var b=a.instanceMethods(false),c=b.length;while(c--)this._L.store(a.instanceMethod(b[c]),0)};g.call(this,d);g.call(this,d.__eigen__())},attach:function(){var a=this._1t;y.addObserver(this);h.Method.trace([a,a.__eigen__()])},detach:function(){var a=this._1t;h.Method.untrace([a,a.__eigen__()]);y.removeObserver(this)},update:function(a,b){if(a!=='call')return;var c=this._L.assoc(b.method);if(c)c.setValue(c.value+1)},report:function(){var c=this._L.entries().sort(function(a,b){return b.value-a.value});var d=this._L.all(function(a){return a.value>0});this.printTable(c,function(a,b){if(a[1]===0)return['bgred','white'];return(b%2===0)?['bold']:[]});return d},printTable:function(j,k){var m=[],j=[['Method','Calls']].concat(j),l=p,o=j.length,n,q;while(o--){n=j[o].length;while(n--){m[n]=m[n]||0;q=(j[o][n]===undefined?'':j[o][n]).toString();m[n]=Math.max(q.length,m[n])}}var r='+',n=m.length;while(n--)r='+'+this.repeat('-',m[n]+2)+r;r='  '+r;l.reset();l.puts();l.puts(r);var v=function(a,b){var c=j[a];l.reset();l.print('  ');for(var d=0,g=c.length;d<g;d++){l.reset();l.print('|');l.consoleFormat.apply(l,b);l.print(' '+this.pad(c[d],m[d])+' ')}l.reset();l.puts('|')};v.call(this,0,['bold']);l.reset();l.puts(r);for(var o=1,w=j.length;o<w;o++){var x=k?k(j[o],o):[];v.call(this,o,x)}l.reset();l.puts(r)},pad:function(a,b){a=(a===undefined?'':a).toString();return a+this.repeat(' ',b-a.length)},repeat:function(a,b){var c='';while(b--)c+=a;return c}})});f.extend({Helpers:new h.Module({$R:function(a,b){return new A(a,b)},$w:function(a){return a.split(/\s+/)},forEach:function(a,b,c){for(var d=0,g=a.length;d<g;d++){b.call(c||null,a[d],d)}},its:function(){return new C()},map:function(a,b,c){return new t.Collection(a).map(b,c)},repeat:function(a,b,c){while(a--)b.call(c)}})});f.extend({Runner:new h.Class({initialize:function(a){this._1u=(typeof a==='string')?{format:a}:(a||{})},run:function(a,b){var c=this.klass.getUI(this._1u);this.prepare(function(){this.start(c,a,b)},this)},prepare:function(a,b){var c=f.Reporters,d=0,g=false;for(var j in c){if(!c[j]||!c[j].prepare)continue;d+=1;c[j].prepare(function(){d-=1;if(d===0&&g)a.call(b||null)})}g=true;if(d===0)a.call(b||null)},start:function(d,g,j){var k=h.extend(d.getOptions(),this._1u),m=d.getReporters(k),l=this.getSuite(k);this.setReporter(new f.Reporters.Composite(m));if(g)g.call(j||null,this);var o=new f.Unit.TestResult(),n=f.Unit.TestResult,q=f.Unit.TestSuite,r=f.Unit.TestCase;var v=o.addListener(n.CHANGED,function(){var a=o.metadata();this._3.update(this.klass.timestamp(a))},this);var w=o.addListener(n.FAULT,function(a){this._3.addFault(this.klass.timestamp(a.metadata()))},this);var x=function(){o.removeListener(n.CHANGED,v);o.removeListener(n.FAULT,w);var a=o.metadata();this._3.endSuite(this.klass.timestamp(a))};var E=function(a,b){var c=this.klass.timestamp(b.metadata());if(a===q.STARTED)this._3.startContext(c);else if(a===r.STARTED)this._3.startTest(c);else if(a===r.FINISHED)this._3.endTest(c);else if(a===q.FINISHED)this._3.endContext(c)};this.klass.reportEventId=0;this._3.startSuite(this.klass.timestamp(l.metadata()));l.run(o,x,E,this)},addReporter:function(a){var b=this._3;if(!(b instanceof f.Reporters.Composite)){this._3=new f.Reporters.Composite();this._3.addReporter(b)}this._3.addReporter(a)},setReporter:function(a){this._3=a},getSuite:function(a){var b=a.test;f.Unit.TestCase.resolve();var c=f.Unit.TestCase.suite(b);f.Unit.TestCase.clear();return c},extend:{timestamp:function(a){a.eventId=this.reportEventId++;a.timestamp=new h.Date().getTime();return a},getUI:function(a){if(p.BROWSER&&!p.PHANTOM)return new f.UI.Browser(a);else return new f.UI.Terminal(a)},filter:function(a,b){var c=this.getUI().getOptions().test,d=c.length,g=[],j,k;if(d===0)return a;while(d--){j=a.length;while(j--){k=a[j].replace(new RegExp(b+'$'),'');if(c[d].substr(0,k.length)===k)g.push(a[j])}}return g}}}),autorun:function(a,b,c){if(typeof a==='function'){c=b;b=a;a={}}if(typeof b!=='function'){b=undefined;c=undefined}var d=new f.Runner(a);d.run(b,c)}});D.Test=f});
//@ sourceMappingURL=test.js.map