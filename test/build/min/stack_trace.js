(function(a){var b=(typeof exports==='object'),c=(typeof JS==='undefined')?require('./core'):JS,g=c.Observable||require('./observable').Observable,f=c.Enumerable||require('./enumerable').Enumerable,d=c.Console||require('./console').Console;if(b)exports.JS=exports;a(c,g,f,d,b?exports:c)})(function(j,l,k,h,m){'use strict';var i=new j.Module('StackTrace',{extend:{logger:new j.Singleton({include:h,active:false,update:function(a,b){if(!this.active)return;switch(a){case'call':return this.logEnter(b);case'return':return this.logExit(b);case'error':return this.logError(b)}},indent:function(){var a=' ';i.forEach(function(){a+='|  '});return a},fullName:function(a){var b=h,c=a.method,g=a.env,f=c.name,d=c.module;return b.nameOf(g)+(d===g?'':'('+b.nameOf(d)+')')+'#'+f},logEnter:function(a){var b=this.fullName(a),c=h.convert(a.args).replace(/^\[/,'(').replace(/\]$/,')');if(this._0)this.puts();this.reset();this.print(' ');this.consoleFormat('bgblack','white');this.print('TRACE');this.reset();this.print(this.indent());this.blue();this.print(b);this.red();this.print(c);this.reset();this._0=true},logExit:function(a){var b=this.fullName(a);if(a.leaf){this.consoleFormat('red');this.print(' --> ')}else{this.reset();this.print(' ');this.consoleFormat('bgblack','white');this.print('TRACE');this.reset();this.print(this.indent());this.blue();this.print(b);this.red();this.print(' --> ')}this.consoleFormat('yellow');this.puts(h.convert(a.result));this.reset();this.print('');this._0=false},logError:function(a){this.puts();this.reset();this.print(' ');this.consoleFormat('bgred','white');this.print('ERROR');this.consoleFormat('bold','red');this.print(' '+h.convert(a));this.reset();this.print(' thrown by ');this.bold();this.print(i.top().name);this.reset();this.puts('. Backtrace:');this.backtrace()},backtrace:function(){i.reverseForEach(function(a){var b=h.convert(a.args).replace(/^\[/,'(').replace(/\]$/,')');this.print('      | ');this.consoleFormat('blue');this.print(a.name);this.red();this.print(b);this.reset();this.puts(' in ');this.print('      |  ');this.bold();this.puts(h.convert(a.object))},this);this.reset();this.puts()}}),include:[l,k],wrap:function(b,c,g){var f=i;var d=function(){var a;f.push(this,c,g,Array.prototype.slice.call(arguments));try{a=b.apply(this,arguments)}catch(e){f.error(e)}f.pop(a);return a};d.toString=function(){return b.toString()};d.__traced__=true;return d},stack:[],forEach:function(a,b){k.forEach.call(this.stack,a,b)},top:function(){return this.stack[this.stack.length-1]||{}},push:function(a,b,c,g){var f=this.stack;if(f.length>0)f[f.length-1].leaf=false;var d={object:a,method:b,env:c,args:g,leaf:true};d.name=this.logger.fullName(d);this.notifyObservers('call',d);f.push(d)},pop:function(a){var b=this.stack.pop();b.result=a;this.notifyObservers('return',b)},error:function(a){if(a.logged)throw a;a.logged=true;this.notifyObservers('error',a);this.stack=[];throw a;}}});i.addObserver(i.logger);m.StackTrace=i});
//@ sourceMappingURL=stack_trace.js.map